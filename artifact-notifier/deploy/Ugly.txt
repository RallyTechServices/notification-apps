<!DOCTYPE html>
<html>
<head>
    <title>CATS-Notifier App-0.1</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Tue Dec 08 2020 09:46:47 GMT-0700 (Mountain Standard Time) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue Dec 08 2020 09:46:47 GMT-0700 (Mountain Standard Time)";
        var ARTIFACT = "";
        var BUILDER  = "kc683795";
        var CHECKSUM = 20782932587;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("RallyCommunity.app.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.rallyappinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,showLog:!1,logger:null,items:[{xtype:"container",itemId:"information"},{xtype:"container",itemId:"button_box"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}this.showLog&&this.logger&&this.down("#button_box").add({xtype:"rallybutton",text:"Show Log",listeners:{scope:this,click:function(){this.logger.displayLog()}}}),a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,dock:"bottom"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created for the RallyCommunity."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);ARTIFACT&&(a=a+"<br/>Source artifact: "+ARTIFACT),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"top",html:a})}}}),Ext.define("RallyCommunity.app.Logger",{saveForLater:!1,saveLines:100,logArray:[],constructor:function(a){Ext.apply(this,a)},setSaveForLater:function(a){this.saveForLater=a},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),this.saveForLater&&(this.logArray||(this.logArray=[]),this.logArray.push(c.join(" ")),this.logArray.length>this.saveLines&&this.logArray.shift()),window.console&&console.log.apply(console,c)},getLogText:function(){return this.logArray&&0!==this.logArray.length?this.logArray.join("<br/>"):"-- no log --"},displayLog:function(){var a=this.getLogText();this.popup=Ext.create("Rally.ui.dialog.Dialog",{width:Ext.getBody().getWidth()-20,height:Ext.getBody().getHeight()-20,closable:!0,title:"Log",autoShow:!0,layout:"border",defaults:{layout:"fit",width:"50%",border:!1},items:[{region:"center",xtype:"container",html:a,autoScroll:!0}]})}}),Ext.define("Settings.UserComboBox",{extend:"Rally.ui.combobox.ComboBox",alias:"widget.settingsusercombobox",config:{editable:!0,typeAhead:!0,queryMode:"remote",minChars:0,forceSelection:!0,selectOnFocus:!0,emptyText:"Search...",allowNoEntry:!0,noEntryText:"-- None --",listConfig:{overflowX:"hidden"},storeConfig:{autoLoad:!1,model:"user",pageSize:10,remoteFilter:!0,sorters:[{property:"UserName",direction:"ASC"}]},displayField:"UserName",valueField:"ObjectUUID"},initComponent:function(){this.callParent(arguments),this.getStore()&&this.relayEvents(this.getStore(),["load"],"store")},constructor:function(a){a.value&&Ext.merge(a,{storeConfig:{filters:[{property:"ObjectUUID",operator:"=",value:a.value}]}}),this.callParent(arguments)},beforeQuery:function(a){var b=a.query,c=this.store.filters.getRange(),d=Rally.data.wsapi.Filter.or([{property:"UserName",operator:"contains",value:b},{property:"DisplayName",operator:"contains",value:b},{property:"FirstName",operator:"contains",value:b},{property:"LastName",operator:"contains",value:b},{property:"EmailAddress",operator:"contains",value:b}]);return b?a.query=d.toString():c.length&&(a.query=Rally.data.wsapi.Filter.and(c).toString()),this.callParent(arguments)}}),Ext.define("RallyCommunity.app.notiferApp.Settings",{singleton:!0,validate:function(a,b){_.each(a,function(a,c){b.log("setting ["+c+"]: "+a)});var c=[];return a.objectType||c.push("An object type must be selected in the app settings."),a.messageText||c.push("A message must be specified in app settings"),a.notificationUserField||a.defaultUserUUID||c.push("Please specify a User field or default User to notify."),a.notificationField||c.push("Please specify a field for notifications to be written to."),c},getSettingsFields:function(a,b){var c="5 0 5 0",d=a&&a.query,e=300,f=500,g=b||a.objectFilters||[{property:"Creatable",value:!0}],h=a.allowDefaultToCreator||!1,i=[{name:"objectType",xtype:"rallycombobox",fieldLabel:"Object Type",labelWidth:e,labelAlign:"right",emptyText:"Choose Object Type...",valueField:"TypePath",displayField:"Name",storeConfig:{model:"TypeDefinition",sorters:[{property:"DisplayName"}],fetch:["DisplayName","TypePath"],filters:g,autoLoad:!1,remoteSort:!1,sortOnLoad:!0,remoteFilter:!0},valueField:"TypePath",displayField:"DisplayName",listeners:{change:function(a){a.fireEvent("typeselected",a.getValue(),a.context)},ready:function(a){a.fireEvent("typeselected",a.getValue(),a.context)}},bubbleEvents:["typeselected"],readyEvent:"ready"},{name:"notificationUserField",xtype:"rallyfieldcombobox",fieldLabel:"User Field to Notify",labelWidth:e,width:f,labelAlign:"right",readyEvent:"ready",handlesEvents:{typeselected:function(a,b){var c=Ext.Array.from(a)[0];c?this.refreshWithNewModelType(c,b):(this.store.removeAll(),this.reset())}},_isNotHidden:function(a){return a.attributeDefinition&&"User"===a.attributeDefinition.SchemaType?!0:!1}}];return h===!0?i.push({name:"defaultToCreator",xtype:"rallycheckboxfield",fieldLabel:"Notify Creator if User Field is empty",labelWidth:e,labelAlign:"right",enabled:h}):i.push({name:"defaultUserUUID",xtype:"settingsusercombobox",labelWidth:e,width:f,labelAlign:"right",fieldLabel:"Default User to notify (if User Field is empty)",value:a.defaultUserUUID}),i=i.concat([{name:"notificationField",xtype:"rallyfieldcombobox",fieldLabel:"Notification Field",labelWidth:e,width:f,labelAlign:"right",readyEvent:"ready",handlesEvents:{typeselected:function(a,b){var c=Ext.Array.from(a)[0];c?this.refreshWithNewModelType(c,b):(this.store.removeAll(),this.reset())}},_isNotHidden:function(a){if(a.attributeDefinition){if("TEXT"===a.attributeDefinition.AttributeType&&a.readOnly===!1)return!0;if("Discussion"===a.attributeDefinition.Name)return!0}return!1}},{name:"messageText",xtype:"textarea",labelWidth:e,labelAlign:"right",labelSeparator:"",flex:1,anchor:"100%",fieldLabel:"Nofication Message"},{name:"query",xtype:"textarea",width:"100%",labelWidth:e,labelAlign:"right",labelSeparator:"",fieldLabel:"Query",margin:"2 0 2 0",flex:1,anchor:"100%",plugins:["rallyfieldvalidationui"],emptyText:"Type a Rally Query like ( ObjectID > 0 )...",value:d,validateOnBlur:!0,validateOnChange:!1,validator:function(a){if(!a)return"Query is required.";try{return a&&Rally.data.wsapi.Filter.fromQueryString(a),!0}catch(b){return b.message}},listeners:{validitychange:function(){this.fireEvent("rowvalidate",this)}}},{name:"safetyLimit",xtype:"rallynumberfield",minValue:0,maxValue:a.maxSafetyLimit||1e4,fieldLabel:"Saftey Limit",labelWidth:e,labelAlign:"right"},{name:"saveLog",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:c,boxLabel:'Save Logging<br/><span style="color:#999999;"><i>Save last 100 lines of log for debugging.</i></span>'}])}}),Ext.define("UserNotification.Base",{mixins:{observable:"Ext.util.Observable"},config:{record:null,notificationColor:"red",messageText:null,defaultNotificationUserUUID:null,notificationUserField:null,notificationField:null,defaultToCreator:!1,createdByField:"CreatedBy",identifierField:null},constructor:function(a){this.mixins.observable.constructor.call(this,a),Ext.apply(this,a)},send:function(){this.record||this.fireEvent("notifyerror","No record provided."),this.fireEvent("notifyerror","Base class implemented, no message sent.")},getRecordIdentifier:function(){return this.record.get("FormattedID")||this.record.get("Name")||this.record.get("_ref")},getNotificationField:function(){return this.notificationField},_buildNotificationText:function(){var a=this._getUserNotificationFieldUUID(this.record);if(!a)return this.fireEvent("notifyerror","No user found to mention for "+this.getRecordIdentifier()),null;if(!this.messageText)return this.fireEvent("notifyerror","No message text specified for "+this.getRecordIdentifier()),null;var b='<p><span class="mention" contenteditable="false" data-mention="{0}" style="color:{2}">{1}</span></p>';return Ext.String.format(b,a,this.messageText,this.notificationColor)},_getUserNotificationFieldUUID:function(){var a=this.notificationUserField,b=this.defaultToCreator;if(!a&&!b&&!this.defaultNotificationUserUUID)return null;var c=this.record&&this.record.get(a)&&this.record.get(a)._refObjectUUID||null;return!c&&b&&(c=this.record&&this.record.get(this.createdByField)._refObjectUUID||null),c||this.defaultNotificationUserUUID}}),Ext.define("UserNotification.TextField",{extend:"UserNotification.Base",send:function(){if(!this.record)return void this.fireEvent("notifyerror","No record provided.");var a=this.record.get(this.getNotificationField())||"",b=this._buildNotificationText();if(null!==b){b=Ext.String.format("{0} <br/>{1} {2}",a,Rally.util.DateTime.formatWithDefaultDateTime(new Date),b);var c=this.getRecordIdentifier();console.log("notification",this.getNotificationField(),b),this.record.set(this.getNotificationField(),b),this.record.save({callback:function(a,b){b.wasSuccessful()?this.fireEvent("notifysuccess",c):this.fireEvent("notifyerror",c)},scope:this})}}}),Ext.define("UserNotification.Discussion",{extend:"UserNotification.Base",send:function(){if(!this.record)return void this.fireEvent("notifyerror","No record provided.");var a=this.record.getCollection("Discussion"),b=this._buildNotificationText();if(null!==b){var c=this.getRecordIdentifier();a.load({callback:function(){a.add({Text:b}),a.sync({success:function(){this.fireEvent("notifysuccess",c)},failure:function(){this.fireEvent("notifyerror","Failed to save mention for "+c)},scope:this})},scope:this})}}}),Ext.define("RallyCommunity.app.ViolationContainer",{extend:"Ext.container.Container",alias:"widget.violationscontainer",config:{record:null,notificationColor:"red",messageText:null,defaultNotificationUserUUID:null,notificationUserField:null,notificationField:null,defaultToCreator:!1,createdByField:"CreatedBy",identifierField:null,settings:{},context:null},constructor:function(a){this.callParent([a]),this.addEvents("loadingstart","loadingerror","loadingcomplete"),this.build()},build:function(){this.update("No violations have been loaded becuase there is no logic.  Please extend the Violation container class to include a build method for the display and a getRecords method for the notification.")},getRecords:function(){var a=Ext.create("Deft.Deferred");return a.resolve([]),a}}),Ext.define("RallyCommunity.app.NotifierApp",{extend:"Rally.app.App",componentCls:"app",logger:new RallyCommunity.app.Logger,defaults:{margin:10},integrationHeaders:{name:"RallyCommunity.app.NotifierApp"},config:{defaultSettings:{defaultToCreator:!1,defaultUserUUID:null,messageText:"This is a message",notificationColor:"red",notificationField:null,notificationUserField:"Owner",objectType:null,query:"(ObjectID > 0)",referenceProject:null,violationsContainerType:"violationscontainer",useProjectScope:!1,safetyLimit:100,maxSafetyLimit:1e3}},showDuration:2e3,launch:function(){var a=RallyCommunity.app.notiferApp.Settings.validate(this.getSettings(),this.logger);return a&&a.length>0?void this.add({xtype:"container",itemId:"notification_box",html:a.join("<br/>")}):(this.add({xtype:"container",itemId:"notification_box",layout:"vbox"}),this.enableSendNotifications()&&(this.logger.log("send notifications enabled!"),this.down("#notification_box").add({xtype:"rallybutton",text:"Send Notifications",iconCls:"icon-bell",cls:"send-notifications",handler:this._sendNotifications,scope:this})),this.down("#notification_box").add({xtype:"container",itemId:"notification_text",cls:"notification-label",html:Ext.String.format('<p><span style="color:{1};">{0}</span></p>',this.getSetting("messageText"),this.getSetting("notificationColor")),readOnly:!0,width:"75%"}),this.logger.log("ViolationsContainerType = "+this.getViolationsContainerType()),void this.add({xtype:this.getViolationsContainerType(),itemId:"violations",settings:this.getSettings(),context:this.getContext(),listeners:{loadingstart:this.startLoading,loadingcomplete:this.stopLoading,loadingerror:this._notifyError,scope:this}}))},enableSendNotifications:function(){try{for(var a=this.getContext().getPermissions(),b=Rally.util.Ref.getOidFromRef(this.getContext().getWorkspace()._ref),c=0;c<a.userPermissions.length;c++){if("Subscription Admin"===a.userPermissions[c].Role)return this.logger.log("Current user is subscription administrator.  Enabling send notifications."),c=a.userPermissions.length,!0;if("Workspace Admin"===a.userPermissions[c].Role){var d=Rally.util.Ref.getOidFromRef(a.userPermissions[c]._ref);if(d===b)return this.logger.log("Current user is workspace administrator for the current workspace.  Enabling send notifications."),!0}}}catch(e){this.logger.log("Error checking permissions: "+e)}return!1},startLoading:function(a){a=a||"Loading possible violations...",this.setLoading(a)},stopLoading:function(){this.setLoading(!1)},_sendNotifications:function(){this.success=0,this.failure=0,this.failureMessages=[];var a=this.getNotificationType(),b=this.getSetting("messageText"),c=this.getSetting("defaultUserUUID"),d=this.getSetting("notificationUserField"),e=this.getSetting("defaultToCreator"),f=this.getSetting("notificationColor"),g=this.getSetting("notificationField");this.logger.log("notificationField",g),this.down("#violations").getRecords().then({success:function(h){this.total=h.length;var i=h.length;this.getSafetyLimit()>0&&i>this.getSafetyLimit()&&(i=this.getSafetyLimit(),this.total=i);for(var j=0;i>j;j++)try{var k=h[j],l=Ext.create(a,{record:k,messageText:b,defaultNotificationUserUUID:c,notificationUserField:d,defaultToCreator:e,notificationColor:f,notificationField:g,listeners:{notifyerror:this._notifyError,notifysuccess:this._notifySuccess,scope:this}});l.send()}catch(m){this._notifyError("Unexpected error sending notification: "+m)}},failure:this._notifyError,scope:this})},getSafetyLimit:function(){return this.getSetting("safetyLimit")},_notifyError:function(a){this.logger.log("notification Error! ",a),this.failure++,this.failureMessages.push(a),this.success+this.failure>=this.total&&this._notifyComplete()},_notifySuccess:function(a){this.logger.log("notifying ",a),this.success++,console.log("total",this.success+this.failure),this.success+this.failure>=this.total&&this._notifyComplete()},_notifyComplete:function(){this.logger.log("Notification updates complete.  Success="+this.success+", Failures="+this.failure+", Total="+this.total);var a=Ext.String.format("{0} of {1} notifications made successfully.",this.success,this.total);this.failureMessages.length>0?(a+="<br><br>Notification Errors:<br>"+this.failureMessages.join("<br>"),Rally.ui.notify.Notifier.showWarning({message:a,showDuration:this.showDuration,allowHTML:!0})):Rally.ui.notify.Notifier.show({message:a,showDuration:this.showDuration})},getViolationsContainerType:function(){return this.getSetting("violationsContainerType")},getNotificationType:function(){return"Discussion"===this.getSetting("notificationField")?"UserNotification.Discussion":"UserNotification.TextField"},getSettingsFields:function(){return RallyCommunity.app.notiferApp.Settings.getSettingsFields(this.getSettings())},getOptions:function(){var a=[{text:"About...",handler:this._launchInfo,scope:this}];return a},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("RallyCommunity.app.InfoLink",{showLog:this.getSetting("saveLog"),logger:this.logger})},isExternal:function(){return"undefined"==typeof this.getAppId()}}),Ext.define("RallyCommunity.app.ArtifactViolationContainer",{extend:"RallyCommunity.app.ViolationContainer",alias:"widget.artifactviolationcontainer",config:{record:null,notificationColor:"red",messageText:null,defaultNotificationUserUUID:null,notificationUserField:null,notificationField:null,defaultToCreator:!1,createdByField:"CreatedBy",identifierField:null,settings:{},context:null},build:function(){this._loadData()},getRecords:function(){var a=Ext.create("Deft.Deferred"),b=this.getObjectType(),c=this.down("rallyinlinefilterbutton").getWsapiFilter(),d=this.getFilters(c),e={project:null};this.settings.useProjectScope&&(e=this.context.getDataContext());var f=this.settings.safetyLimit||"Infinity";return this.fireEvent("loadingStart"),Ext.create("Rally.data.wsapi.Store",{model:b,fetch:this.getNotificationFields(),filters:d,context:e,limit:f,pageSize:2e3}).load({scope:this,callback:function(b,c,d){this.fireEvent("loadingComplete"),c.wasSuccessful()?a.resolve(b):a.reject(c&&c.error&&c.error.errors&&c.error.errors.join(","))}}),a},_loadData:function(){var a=this.getObjectType();this.down("rallygridboard")&&this.destroy("rallygridboard");var b={project:null};this.settings.useProjectScope&&(b=this.context.getDataContext()),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[a],fetch:this.getNotificationFields(),filters:this.getFilters(),autoLoad:!1,context:b,enableHierarchy:!1}).then({success:this._buildGrid,scope:this})},_buildGrid:function(a){var b=this.getObjectType(),c={project:null};this.settings.useProjectScope&&(c=this.context.getDataContext()),this.add({xtype:"rallygridboard",context:this.context,modelNames:[b],toggleState:"grid",plugins:[{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{modelNames:[b],inlineFilterPanelConfig:{collapsed:!1}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:[b]}],gridConfig:{store:a,storeConfig:{filters:this.getFilters(),context:c},enableBulkEdit:!1,enableEditing:!1,enableRanking:!1,shouldShowRowActionsColumn:!1,columnCfgs:["FormattedID","Name","CreatedBy","Project"]},height:400})},getObjectType:function(){return this.settings.objectType},getFilters:function(a){var b=null;return this.settings.query&&(b=Rally.data.wsapi.Filter.fromQueryString(this.settings.query)),b&&a?(console.log("getFilters",a),b.and(a)):b||a||[]},getNotificationFields:function(){var a=["FormattedID"];return("true"==this.settings.defaultToCreator||1==this.settings.defaultToCreator)&&a.push("CreatedBy"),this.settings.notificationUserField&&a.push(this.settings.notificationUserField),a.push(this.settings.notificationField),a},_showError:function(a){this.fireEvent("loadingerror",a)}}),Ext.define("RallyCommunity.app.ArtifactNotifierApp",{extend:"RallyCommunity.app.NotifierApp",integrationHeaders:{name:"RallyCommunity.app.ArtifactNotifierApp"},config:{defaultSettings:{violationsContainerType:"artifactviolationcontainer",objectFilters:Rally.data.wsapi.Filter.or([{property:"TypePath",operator:"contains",value:"PortfolioItem/"},{property:"Typepath",value:"HierarchicalRequirement"},{property:"TypePath",value:"Defect"},{property:"TypePath",value:"Task"},{property:"TypePath",value:"TestCase"},{property:"TypePath",value:"DefectSuite"},{property:"TypePath",value:"TestSet"}]),allowDefaultToCreator:!0,useProjectScope:!1}}});

               Rally.launchApp('RallyCommunity.app.ArtifactNotifierApp', {
                   name: 'Notifier App'
               });
        });
    </script>

    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.send-notifications {
    background-color: #EE1C25;
}

.notification-label {
    font-family:NotoSans;
    white-space:nowrap;
    font-size:13px;
}
    </style>

</head>
<body></body>
</html>