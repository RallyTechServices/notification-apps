Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,showLog:!1,logger:null,items:[{xtype:"container",itemId:"information"},{xtype:"container",itemId:"button_box"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}this.showLog&&this.logger&&this.down("#button_box").add({xtype:"rallybutton",text:"Show Log",listeners:{scope:this,click:function(){this.logger.displayLog()}}}),a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,dock:"bottom"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created for the Rally Community."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"top",html:a})}}}),Ext.define("CArABU.technicalservices.Logger",{saveForLater:!1,saveLines:100,logArray:[],constructor:function(a){Ext.apply(this,a)},setSaveForLater:function(a){this.saveForLater=a},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),this.saveForLater&&(this.logArray||(this.logArray=[]),this.logArray.push(c.join(" ")),this.logArray.length>this.saveLines&&this.logArray.shift()),window.console&&console.log.apply(console,c)},getLogText:function(){return this.logArray&&0!==this.logArray.length?this.logArray.join("<br/>"):"-- no log --"},displayLog:function(){var a=this.getLogText();this.popup=Ext.create("Rally.ui.dialog.Dialog",{width:Ext.getBody().getWidth()-20,height:Ext.getBody().getHeight()-20,closable:!0,title:"Log",autoShow:!0,layout:"border",defaults:{layout:"fit",width:"50%",border:!1},items:[{region:"center",xtype:"container",html:a,autoScroll:!0}]})}}),Ext.define("TSUtilities",{singleton:!0,loadWsapiRecords:function(a){var b=Ext.create("Deft.Deferred"),c={model:"Defect",fetch:["ObjectID"]};return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge(c,a)).load({callback:function(a,c,d){d?b.resolve(a):(console.error("Failed: ",c),b.reject("Problem loading: "+c.error.errors.join(". ")))}}),b.promise},loadAStoreWithAPromise:function(a,b){var c=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:a,fetch:b}).load({callback:function(a,b,d){d?c.resolve(this):(console.error("Failed: ",b),c.reject("Problem loading: "+b.error.errors.join(". ")))}}),c.promise}}),Ext.define("UserNotification.Base",{mixins:{observable:"Ext.util.Observable"},config:{record:null,notificationColor:"red",messageText:null,defaultNotificationUserUUID:null,notificationUserField:null,notificationField:null,defaultToCreator:!1,createdByField:"CreatedBy"},constructor:function(a){this.mixins.observable.constructor.call(this,a),Ext.apply(this,a)},send:function(){this.record||this.fireEvent("notifyerror","No record provided."),this.fireEvent("notifyerror","Base class implemented, no message sent.")},_buildNotificationText:function(){var a=this._getUserNotificationFieldUUID(this.record);if(!a)return this.fireEvent("notifyerror","No user found to mention for "+this.record.get("FormattedID")),null;if(!this.messageText)return this.fireEvent("notifyerror","No message text specified for "+this.record.get("FormattedID")),null;var b='<p><span class="mention" contenteditable="false" data-mention="{0}" style="color:{2}">{1}</span></p>';return Ext.String.format(b,a,this.messageText,this.notificationColor)},_getUserNotificationFieldUUID:function(){var a=this.notificationUserField,b=this.defaultToCreator;if(!a)return null;var c=this.record&&this.record.get(a)&&this.record.get(a)._refObjectUUID||null;return!c&&b&&(c=this.record&&this.record.get(this.createdByField)._refObjectUUID||null),c||this.defaultNotificationUserUUID}}),Ext.define("UserNotification.TextField",{extend:"UserNotification.Base",send:function(){if(!this.record)return void this.fireEvent("notifyerror","No record provided.");var a=this.record.get(this.notificationField)||"",b=this._buildNotificationText();if(null!==b){var b=Ext.String.format("{0} <br/>{1} {2}",a,Rally.util.DateTime.formatWithDefaultDateTime(new Date),b),c=this.record.get("FormattedID");this.record.set(this.notificationField,b),this.record.save({callback:function(a,b){b.wasSuccessful()?this.fireEvent("notifysuccess",c):this.fireEvent("notifyerror",c)},scope:this})}}}),Ext.define("UserNotification.Discussion",{extend:"UserNotification.Base",send:function(){if(console.log("send discussion"),!this.record)return void this.fireEvent("notifyerror","No record provided.");var a=this.record.getCollection("Discussion"),b=this._buildNotificationText();if(null!==b){var c=this.record.get("FormattedID");a.load({callback:function(){a.add({Text:b}),a.sync({success:function(){this.fireEvent("notifysuccess",c)},failure:function(){this.fireEvent("notifyerror","Failed to save mention for "+c)},scope:this})},scope:this})}}}),Ext.define("RallyCommunity.app.NotifierApp",{extend:"Rally.app.App",componentCls:"app",logger:new CArABU.technicalservices.Logger,defaults:{margin:10},items:[{xtype:"container",flex:1,itemId:"grid_box1",region:"west"},{xtype:"container",flex:1,itemId:"grid_box2",region:"east"}],integrationHeaders:{name:"RallyCommunity.app.NotifierApp"},config:{defaultSettings:{object_type:"hierarchicalrequirement",query:"(ObjectID = 0)",message_text:"ACTION REQUESTED: This item is orphaned.  Please assign a Feature Parent to this item.",defaultToCreator:!0,notificationUserField:"Owner",notificationField:"Discussion",useDataContext:!0,defaultNotificationUserUUID:null,notificationColor:"red"}},launch:function(){this._validateSettings()&&(this.add({xtype:"container",itemId:"notification_box",layout:"vbox"}),this.down("#notification_box").add({xtype:"rallybutton",text:"Send Notifications",iconCls:"icon-bell",cls:"send-notifications",handler:this._sendNotifications,scope:this}),this.down("#notification_box").add({xtype:"container",itemId:"notification_text",cls:"notification-label",html:Ext.String.format('<p><span style="color:{1};">{0}</span></p>',this.getSetting("message_text"),this.getSetting("notificationColor")),readOnly:!0,width:"75%"}),this._loadData())},_validateSettings:function(){var a=[];return this.getSetting("object_type")||a.push("An object type must be selected in the app settings."),this.getSetting("message_text")||a.push("A message must be specified in app settings"),this.getSetting("notificationUserField")||this.getSettings("defaultToCreator")||a.push("Please specify a User field to notify."),a.length>0?(this.add({xtype:"container",itemId:"notification_box",html:a.join("<br/>")}),!1):!0},_sendNotifications:function(){var a=(this.down("rallygridboard").getGridOrBoard().getStore(),this.getSetting("object_type")),b=this.down("rallyinlinefilterbutton").getWsapiFilter(),c=this.getFilters(b);this.success=0,this.failure=0;var d=this.getNotificationType(),e=this.getSetting("message_text"),f=this.getSetting("defaultNotificationUserUUID"),g=this.getSetting("notificationUserField"),h=this.getSetting("defaultToCreator");Ext.create("Rally.data.wsapi.Store",{model:a,fetch:this.getNotificationFields(),filters:c,limit:1/0,pageSize:2e3}).load({scope:this,callback:function(a,b,c){if(c)for(var i=0;i<a.length;i++)try{Ext.create(d,{record:a[i],messageText:e,defaultNotificationUserUUID:f,notificationUserField:g,defaultToCreator:h,notificationColor:this.getSetting("notificationColor"),notificationField:this.getSetting("notificationField"),listeners:{notifyerror:this._notifyError,notifysuccess:this._notifySuccess,scope:this}}).send()}catch(j){this.logger.log("Error "+j)}else this.logger.log("Error loading records for notification")}})},_notifyError:function(a){this.logger.log("_notifyError",a)},_notifySuccess:function(a){this.logger.log("_notifySuccess",a)},_loadData:function(){var a=this.getSetting("object_type");this.getContext();this.down("rallygridboard")&&this.destroy("rallygridboard"),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[a],fetch:this.getNotificationFields(),filters:this.getFilters(),autoLoad:!1,enableHierarchy:!1}).then({success:this._buildGrid,scope:this})},_buildGrid:function(a){var b=this.getSetting("object_type"),c=this.getContext();this.add({xtype:"rallygridboard",context:c,modelNames:[b],toggleState:"grid",plugins:[{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{modelNames:[b],inlineFilterPanelConfig:{collapsed:!1}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:[b]}],gridConfig:{store:a,storeConfig:{filters:this.getFilters()},enableBulkEdit:!1,enableEditing:!1,enableRanking:!1,shouldShowRowActionsColumn:!1,columnCfgs:["FormattedID","Name","CreatedBy","Project"]},height:400})},getScopeContext:function(){return"true"==this.getSetting("useDataContext")||1==this.getSetting("useDataContext")?this.getDataContext():{project:null}},getFilters:function(a){var b=null;return this.getSetting("query")&&(b=Rally.data.wsapi.Filter.fromQueryString(this.getSetting("query"))),b&&a?(console.log("getFilters",a),b.and(a)):b||a||[]},getNotificationFields:function(){var a=["FormattedID"];return("true"==this.getSetting("defaultToCreator")||1==this.getSetting("defaultToCreator"))&&a.push("CreatedBy"),this.getSetting("notificationUserField")&&a.push(this.getSetting("notificationUserField")),a.push(this.getSetting("notificationField")),a},getNotificationType:function(){return"Discussion"===this.getSetting("notificationField")?"UserNotification.Discussion":"UserNotification.TextField"},getUserNotificationFieldUUID:function(a){var b=this.getSetting("notificationUserField"),c="true"==this.getSetting("defaultToCreator")||1==this.getSetting("defaultToCreator"),d=a&&a.get(b)&&a.get(b)._refObjectUUID||null;return!d&&c&&(d=a&&a.get("CreatedBy")._refObjectUUID||null),d||this.getDefaultNotificationUser()},getSettingsFields:function(){var a="5 0 5 0",b=this.getSetting("query"),c=200,d=[{property:"TypePath",operator:"contains",value:"PortfolioItem/"},{property:"Typepath",value:"HierarchicalRequirement"},{property:"TypePath",value:"Defect"},{property:"TypePath",value:"Task"},{property:"TypePath",value:"TestCase"},{property:"TypePath",value:"DefectSuite"},{property:"TypePath",value:"TestSet"}];return d=Rally.data.wsapi.Filter.or(d),[{name:"object_type",xtype:"rallycombobox",fieldLabel:"Object Type",labelWidth:c,labelAlign:"right",emptyText:"Choose Artifact Type...",valueField:"TypePath",displayField:"Name",storeConfig:{model:"TypeDefinition",sorters:[{property:"DisplayName"}],fetch:["DisplayName","TypePath"],filters:d,autoLoad:!1,remoteSort:!1,sortOnLoad:!0,remoteFilter:!0},valueField:"TypePath",displayField:"DisplayName",listeners:{change:function(a){a.fireEvent("typeselected",a.getValue(),a.context)},ready:function(a){a.fireEvent("typeselected",a.getValue(),a.context)}},bubbleEvents:["typeselected"],readyEvent:"ready"},{name:"notificationUserField",xtype:"rallyfieldcombobox",fieldLabel:"User to Notify",labelWidth:c,labelAlign:"right",readyEvent:"ready",handlesEvents:{typeselected:function(a,b){var c=Ext.Array.from(a)[0];c?this.refreshWithNewModelType(c,b):(this.store.removeAll(),this.reset())}},_isNotHidden:function(a){return a.attributeDefinition&&"User"===a.attributeDefinition.SchemaType?!0:!1}},{name:"defaultToCreator",xtype:"rallycheckboxfield",fieldLabel:"Notify Creator if User Field is empty",labelWidth:c},{name:"notificationField",xtype:"rallyfieldcombobox",fieldLabel:"Notification Field",labelWidth:c,labelAlign:"right",readyEvent:"ready",handlesEvents:{typeselected:function(a,b){var c=Ext.Array.from(a)[0];c?this.refreshWithNewModelType(c,b):(this.store.removeAll(),this.reset())}},_isNotHidden:function(a){if(console.log("field",a),a.attributeDefinition){if("TEXT"===a.attributeDefinition.AttributeType&&a.readOnly===!1)return!0;if("Discussion"===a.attributeDefinition.Name)return!0}return!1}},{name:"message_text",xtype:"textarea",labelWidth:c,labelAlign:"right",labelSeparator:"",flex:1,anchor:"100%",fieldLabel:"Nofication Message"},{name:"query",xtype:"textarea",width:"100%",labelWidth:c,labelAlign:"right",labelSeparator:"",fieldLabel:"Query",margin:"2 0 2 0",flex:1,anchor:"100%",plugins:["rallyfieldvalidationui"],emptyText:"Type a Rally Query like ( ObjectID > 0 )...",value:b,validateOnBlur:!0,validateOnChange:!1,validator:function(a){if(!a)return"Query is required.";try{return a&&Rally.data.wsapi.Filter.fromQueryString(a),!0}catch(b){return b.message}},listeners:{validitychange:function(){this.fireEvent("rowvalidate",this)},scope:this}},{name:"saveLog",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:a,boxLabel:'Save Logging<br/><span style="color:#999999;"><i>Save last 100 lines of log for debugging.</i></span>'}]},getDefaultNotificationUser:function(){return this.getSetting("defaultNotificationUserUUID")},getOptions:function(){var a=[{text:"About...",handler:this._launchInfo,scope:this}];return a},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{showLog:this.getSetting("saveLog"),logger:this.logger})},isExternal:function(){return"undefined"==typeof this.getAppId()}});